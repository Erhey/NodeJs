<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <style>
        table {
            margin: auto;
        }

        canvas {
            display: flex;
            flex-direction: column;
            width: 750px;
        }
    </style>
    <script>
        let graphFormat = {}
        const ALL_UNIT = [ "LIVE", "HOUR", "DAY", "MONTH", "YEAR", "ALL" ]


        let unit = [ "LIVE" ]
        $(document).ready(() => {
            $("input[name=show-unit]").on('change', () => {
                // $("input[name=show-unit]")
                unit = []
                $("input[name=show-unit]:checked").each(function () {
                    unit.push($(this).attr("id"))
                    $("#graph-" + $(this).attr("id")).css({ visibility: "visible" })
                })
                $("input[name=show-unit]:not(:checked)").each(function () {
                    $("#graph-" + $(this).attr("id")).css({ visibility: "hidden" })
                })
            })
        })

        let charts = {}
        function getParamValue(paramName) {
            var url = window.location.search.substring(1) //get rid of "?" in querystring
            var qArray = url.split('&') //get key-value pairs
            for (var i = 0; i < qArray.length; i++) {
                var pArr = qArray[i].split('=') //split key and value
                if (pArr[0] == paramName)
                    return pArr[1] //return value
            }
        }
        getAllGraphs = async callback => {
            await $.get("http://localhost:3001/getLiveInfo", (data, status) => {
                let datasets_list = []
                ALL_UNIT.forEach(unit => {
                    datasets_list[unit] = [{
                        "label": "Server requests for page : ",
                        "data": data[unit].req_count["/"],
                        "backgroundColor": [
                            'rgba(54, 162, 235, 0.1)'
                        ],
                        "borderColor": [
                            'rgba(54, 162, 235, 1)'
                        ]
                    },
                    {
                        "label": "Error",
                        "data": data[unit].error_count["/"],
                        "backgroundColor": [
                            'rgba(255, 99, 132, 0.1)'
                        ],
                        "borderColor": [
                            'rgba(255, 99, 132, 1)'
                        ]
                    },
                    {
                        "label": "Scripted requests",
                        "data": data[unit].dangerous_count["/"],
                        "backgroundColor": [
                            'rgba(255, 255, 0, 0.1)'
                        ],
                        "borderColor": [
                            'rgba(255, 255, 0, 1)'
                        ],
                    },
                    {
                        "label": "Response time",
                        "data": data[unit].res_time_moy["/"],
                        "backgroundColor": [
                            'rgba(0, 255, 0, 0.1)'
                        ],
                        "borderColor": [
                            'rgba(0, 255, 0, 1)'
                        ],
                    }
                        //,
                        // datasets = [{
                        //     "label" : "Stay length",
                        //     "data" : data[unit].req_count,
                        //     "backgroundColor": [
                        //         'rgba(0, 255, 0, 0.1)'
                        //     ],
                        //     "borderColor": [
                        //         'rgba(0, 255, 0, 1)'
                        //     ],
                        // },
                    ]
                })
                callback(datasets_list)
            })
        }
        getGraph = async (unit, callback) => {
            await $.get("http://localhost:3001/getLiveInfo", (data, status) => {
                callback([{
                    "label": "Server requests",
                    "data": data[unit].req_count["/"],
                    "backgroundColor": [
                        'rgba(54, 162, 235, 0.1)'
                    ],
                    "borderColor": [
                        'rgba(54, 162, 235, 1)'
                    ]
                },
                {
                    "label": "Error",
                    "data": data[unit].error_count["/"],
                    "backgroundColor": [
                        'rgba(255, 99, 132, 0.1)'
                    ],
                    "borderColor": [
                        'rgba(255, 99, 132, 1)'
                    ]
                },
                {
                    "label": "Scripted requests",
                    "data": data[unit].dangerous_count["/"],
                    "backgroundColor": [
                        'rgba(255, 255, 0, 0.1)'
                    ],
                    "borderColor": [
                        'rgba(255, 255, 0, 1)'
                    ],
                },
                {
                    "label": "Response time",
                    "data": data[unit].res_time_moy["/"],
                    "backgroundColor": [
                        'rgba(0, 255, 0, 0.1)'
                    ],
                    "borderColor": [
                        'rgba(0, 255, 0, 1)'
                    ],
                }
                    //,
                    // datasets = [{
                    //     "label" : "Stay length",
                    //     "data" : data[unit].req_count,
                    //     "backgroundColor": [
                    //         'rgba(0, 255, 0, 0.1)'
                    //     ],
                    //     "borderColor": [
                    //         'rgba(0, 255, 0, 1)'
                    //     ],
                    // },
                ])
            })
        }
        test = () => {
            alert(getParamValue("db"))
        }

        getGlobalDataFromTrackingApi = (db => {
            return db
        })
        createAllGraph = async () => {
            await $.get("http://localhost:3001/getGraphFormat", (data, status) => {
                graphFormat = data
            })
            let datasets_list = []
            await getAllGraphs(async datasets => {
                datasets_list = datasets
            })
            ALL_UNIT.forEach(unit => {
                console.log(unit)
                let ctx = document.getElementById('graph-' + unit).getContext('2d')
                console.log(graphFormat[unit].title)
                charts[unit] = new Chart(ctx, {
                    // charts.push(new Chart(ctx, {
                    type: 'line',
                    data: {
                        "labels": graphFormat[unit].time,
                        "datasets": datasets_list[unit]
                    },
                    options: {
                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                }
                            }]
                        },
                        animation: {
                            duration: 0,
                            easing: 'easeInOutCubic'
                        },
                        tooltips : {
                            enabled : true,
                            intersect : false
                        },
                        title: graphFormat[unit].title,
                        responsive: true,
                        
                    }
                })
            })
            // }))
            // let ctx = document.getElementById('graph-general').getContext('2d');

            // chart = new Chart(ctx, {
            //     type: 'line',
            //     data: {
            //         "labels": ["0","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49", "50", "51", "52", "53", "54", "55", "56", "57", "58", "59"],
            //         "datasets": datasets_list,
            //         options: {
            //             scales: {
            //                 yAxes: [{
            //                     ticks: {
            //                         beginAtZero: true
            //                     }
            //                 }]
            //             },
            //             responsive: true
            //         }
            //     }
            // })

        }
        updateGraphs = async () => {
            console.log(unit)
            await getAllGraphs(async datasets => {
                // console.log(datasets)
                for (let i = 0; i < unit.length; i++) {
                    let chart_modified = false
                    let cpt = 0
                    await datasets[unit[i]].forEach(result => {
                        if(charts[unit[i]].data.datasets[cpt].data.toString() !== result.data.toString()) {
                            charts[unit[i]].data.datasets[cpt].data = result.data
                            chart_modified = true
                        }
                        cpt++
                    })
                    if(chart_modified) {
                        charts[unit[i]].options = {
                            scales: {
                                yAxes: [{
                                    ticks: {
                                        beginAtZero: true
                                    }
                                }]
                            },
                            animation: false,
                            tooltips : {
                                enabled : true,
                                intersect : false
                            },
                            title: graphFormat[unit[i]].title,
                            responsive: true
                        }
                        let activetest =   charts[unit[i]].tooltip._active;
                        charts[unit[i]].update()
                        redrawTooltips(charts[unit[i]], activetest)
                        
                    }
                }
            })
        }
        redrawTooltips = (chart, activetest) => {
            if(chart.tooltip._active == undefined){
                chart.tooltip._active = []
            }
            if(activetest !== undefined){
                var activeElements = activetest;
                chart.tooltip._active = activeElements;
                chart.tooltip.update(true);
                chart.draw();
            }
        }
        createAllGraph()
        setInterval(updateGraphs, 1000)
    </script>
</head>

<body>
    LIVE<input type="checkbox" value="LIVE" name="show-unit" id="LIVE" checked>
    HOUR<input type="checkbox" value="HOUR" name="show-unit" id="HOUR">
    DAY<input type="checkbox" value="DAY" name="show-unit" id="DAY">
    MONTH<input type="checkbox" value="MONTH" name="show-unit" id="MONTH">
    YEAR<input type="checkbox" value="YEAR" name="show-unit" id="YEAR">
    ALL<input type="checkbox" value="ALL" name="show-unit" id="ALL">
    <!-- <div id="graph-info">
        <canvas id="graph-general"></canvas>
    </div> -->
    <div id="resume-info">
        <!-- <ul>
            <li class="characteristic"></li>
            <li class="characteristic"></li>
            <li class="characteristic"></li>
            <li class="characteristic"></li>
            <li class="characteristic"></li>
        </ul> -->
    </div>
    <!-- <div id="canvas" style="display:block; height : 100%; background-color: red;"> -->
    <table border="collide 1px black">
        <tr>
            <td>
                <canvas id="graph-LIVE"></canvas>
                <tooltips id="tooltips-LIVE"></tooltips>
            
            </td>
            <td><canvas id="graph-HOUR" style="visibility: hidden;"></canvas></td>
        </tr>
        <tr>
            <td><canvas id="graph-DAY" style="visibility: hidden;"></canvas></td>
            <td><canvas id="graph-MONTH" style="visibility: hidden;"></canvas></td>
        </tr>
        <tr>
            <td><canvas id="graph-YEAR" style="visibility: hidden;"></canvas></td>
            <td><canvas id="graph-ALL" style="visibility: hidden;"></canvas></td>
        </tr>
    </table>
</body>


</html>