<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <style>
        table {
            margin: auto
        }
        canvas {
            width: 750px;
        }
    </style>
    <script>
        let graphFormat = {}
        let unite = ["LIVE"]
        $(document).ready(() => {
            $("input[name=show-unite]").on('change', () => {
                unite = []
                $("input:checked").each(function () {
                    unite.push($(this).attr("id"))
                })
            })
        })

        let charts = []
        function getParamValue(paramName) {
            var url = window.location.search.substring(1); //get rid of "?" in querystring
            var qArray = url.split('&'); //get key-value pairs
            for (var i = 0; i < qArray.length; i++) 
            {
                var pArr = qArray[i].split('='); //split key and value
                if (pArr[0] == paramName) 
                    return pArr[1]; //return value
            }
        }
        getAllGraphs = async callback => {
            await $.get("http://localhost:3001/getLiveInfo", (data, status) => {
                let datasets_list = []
                // console.log(unite)
                // console.log(data)
                for(let i = 0; i < unite.length; i++){
                    datasets_list.push([{
                        "label" : "Server requests",
                        "data" : data[unite[i]].req_count["/"],
                        "backgroundColor": [
                            'rgba(54, 162, 235, 0.1)'
                        ],
                        "borderColor": [
                            'rgba(54, 162, 235, 1)'
                        ]
                    },
                    {
                        "label" : "Error",
                        "data" : data[unite[i]].error_count["/"],
                            "backgroundColor": [
                                'rgba(255, 99, 132, 0.1)'
                            ],
                            "borderColor": [
                                'rgba(255, 99, 132, 1)'
                            ]
                    },
                    {
                        "label" : "Scripted requests",
                        "data" : data[unite[i]].dangerous_count["/"],
                            "backgroundColor": [
                                'rgba(255, 255, 0, 0.1)'
                            ],
                            "borderColor": [
                                'rgba(255, 255, 0, 1)'
                            ],
                    },
                    {
                        "label" : "Response time",
                        "data" : data[unite[i]].res_time_moy["/"],
                        "backgroundColor": [
                            'rgba(0, 255, 0, 0.1)'
                        ],
                        "borderColor": [
                            'rgba(0, 255, 0, 1)'
                        ],
                    }
                    //,
                    // datasets = [{
                    //     "label" : "Stay length",
                    //     "data" : data[unite].req_count,
                    //     "backgroundColor": [
                    //         'rgba(0, 255, 0, 0.1)'
                    //     ],
                    //     "borderColor": [
                    //         'rgba(0, 255, 0, 1)'
                    //     ],
                    // },
                    ])
                }
                callback(datasets_list)
            })
        }
        getGraph = async (unite, callback) => {
            await $.get("http://localhost:3001/getLiveInfo", (data, status) => {
                callback([{
                    "label" : "Server requests",
                    "data" : data[unite].req_count["/"],
                    "backgroundColor": [
                        'rgba(54, 162, 235, 0.1)'
                    ],
                    "borderColor": [
                        'rgba(54, 162, 235, 1)'
                    ]
                },
                {
                    "label" : "Error",
                    "data" : data[unite].error_count["/"],
                        "backgroundColor": [
                            'rgba(255, 99, 132, 0.1)'
                        ],
                        "borderColor": [
                            'rgba(255, 99, 132, 1)'
                        ]
                },
                {
                    "label" : "Scripted requests",
                    "data" : data[unite].dangerous_count["/"],
                        "backgroundColor": [
                            'rgba(255, 255, 0, 0.1)'
                        ],
                        "borderColor": [
                            'rgba(255, 255, 0, 1)'
                        ],
                },
                {
                    "label" : "Response time",
                    "data" : data[unite].res_time_moy["/"],
                    "backgroundColor": [
                        'rgba(0, 255, 0, 0.1)'
                    ],
                    "borderColor": [
                        'rgba(0, 255, 0, 1)'
                    ],
                }
                //,
                // datasets = [{
                //     "label" : "Stay length",
                //     "data" : data[unite].req_count,
                //     "backgroundColor": [
                //         'rgba(0, 255, 0, 0.1)'
                //     ],
                //     "borderColor": [
                //         'rgba(0, 255, 0, 1)'
                //     ],
                // },
                ])
            })
        }
        test = () => {
            alert(getParamValue("db"))
        }
        
        getGlobalDataFromTrackingApi = ( db => {
            return db
        })
        createGraph = async unite => {
            await $.get("http://localhost:3001/getGraphFormat",  (data, status) => {
                graphFormat = data
            })
            let datasets_list = []
            await getGraph(unite, async datasets => {
                datasets_list = datasets
            })
            let ctx = document.getElementById('graph-' + unite).getContext('2d');
            console.log(graphFormat[unite].title)

            charts.push(new Chart(ctx, {
                type: 'line',
                data: {
                    "labels": graphFormat[unite].time,
                    "datasets": datasets_list
                },
                options : {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    },
                    animation: {
                        duration: 30  ,
                        easing: 'easeInOutCubic'
                    },
                    title : graphFormat[unite].title,
                    responsive: true
                }      
            }))
            // let ctx = document.getElementById('graph-general').getContext('2d');
        
            // chart = new Chart(ctx, {
            //     type: 'line',
            //     data: {
            //         "labels": ["0","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49", "50", "51", "52", "53", "54", "55", "56", "57", "58", "59"],
            //         "datasets": datasets_list,
            //         options: {
            //             scales: {
            //                 yAxes: [{
            //                     ticks: {
            //                         beginAtZero: true
            //                     }
            //                 }]
            //             },
            //             responsive: true
            //         }
            //     }
            // })
            
        }
        updateCreateAllGraphs = async () => {
            await getAllGraphs( async datasets => {
                // console.log(datasets)
                for(let i = 0; i< unite.length; i++) {
                    let cpt = 0
                    if(charts[i] === undefined) {
                        await createGraph(unite[i])
                    }
                    await datasets[i].forEach(result => {
                        // for(let i = 0; i < result.length; i++){
                        charts[i].data.datasets[cpt].data = result.data
                        // }
                        cpt++
                    })
                    charts[i].options = {
                            scales: {
                                yAxes: [{
                                    ticks: {
                                        beginAtZero: true
                                    }
                                }]
                            },
                            animation: {
                                duration: 30  ,
                                easing: 'easeInOutCubic'
                            },
                            title : graphFormat[unite[i]].title,
                            responsive: true
                        }
                    charts[i].update()  
                }
            })
        }
        createGraph("LIVE")  
        setInterval(updateCreateAllGraphs, 1000)
    </script>
</head>
<body>
    LIVE<input type="checkbox" value="LIVE" name="show-unite" id="LIVE" checked>
    HOUR<input type="checkbox" value="HOUR" name="show-unite" id="HOUR">
    DAY<input type="checkbox" value="DAY" name="show-unite" id="DAY">
    MONTH<input type="checkbox" value="MONTH" name="show-unite" id="MONTH">
    YEAR<input type="checkbox" value="YEAR" name="show-unite" id="YEAR">
    ALL<input type="checkbox" value="ALL" name="show-unite" id="ALL">
    <!-- <div id="graph-info">
        <canvas id="graph-general"></canvas>
    </div> -->
    <div id="resume-info">
        <!-- <ul>
            <li class="characteristic"></li>
            <li class="characteristic"></li>
            <li class="characteristic"></li>
            <li class="characteristic"></li>
            <li class="characteristic"></li>
        </ul> -->
    </div>
    <!-- <div id="canvas" style="display:block; height : 100%; background-color: red;"> -->
        <table border="collide 1px black">
            <tr>
                <td><canvas id="graph-LIVE"></canvas></td>
                <td><canvas id="graph-HOUR"></canvas></td>
            </tr>
            <tr>
                <td><canvas id="graph-DAY"></canvas></td>
                <td><canvas id="graph-MONTH"></canvas></td>
            </tr>
            <tr>
                <td><canvas id="graph-YEAR"></canvas></td>
                <td><canvas id="graph-ALL"></canvas></td>
            </tr>
        </table>
    <!-- </div> -->
    <!-- <table>
        <tr>
            <td>Most viewed page :</td>
            <td>"/"</td>
        </tr>
        <tr>
            <td>Number Visitor today</td>
            <td>122</td>
        </tr>
        <tr>
            <td>N</td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
        </tr>
    </table> -->
</body>


</html>