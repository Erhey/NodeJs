<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <!-- <script src="chartBuilder.js"></script> -->
    <script>
        let unite = ["LIVE"]
        $(document).ready(() => {
            $("input[type='checkbox'].unite").on('change', () => {
                unite = []
                $("input[type='checkbox'].unite").each(index => {
                    if ($(this).is(":checked")) {
                        alert("je passe")
                        unite.push($(this).val())
                    }
                })
                console.log(unite)
            })
        })
        let chart = {}
        showLive = async () => {
            if(unite.includes("LIVE")) {
                await updateGraphGeneral()
            }
        }
        showHour = async () => {
            if(unite.includes("HOUR")) {
                await updateGraphGeneral()
            }
        }
        showDay = async () => {
            if(unite.includes("DAY")) {
                await updateGraphGeneral()
            }
        }
        showMonth = async () => {
            if(unite.includes("MONTH")) {
                await updateGraphGeneral()
            }
        }
        showYear = async () => {
            if(unite.includes("YEAR")) {
                await updateGraphGeneral()
            }
        }
        showAll = async () => {
            if(unite.includes("ALL")) {
                await updateGraphGeneral()
            }
        }
        setInterval(showLive, 1000)

        function getParamValue(paramName) {
            var url = window.location.search.substring(1); //get rid of "?" in querystring
            var qArray = url.split('&'); //get key-value pairs
            for (var i = 0; i < qArray.length; i++) 
            {
                var pArr = qArray[i].split('='); //split key and value
                if (pArr[0] == paramName) 
                    return pArr[1]; //return value
            }
        }
        getGraph = async callback => {
            await $.get("http://localhost:3001/getGraph", (data, status) => {
                console.log(data)
                datasets = [{
                    "label" : "Server requests",
                    "data" : data[unite].req_count["/"],
                    "backgroundColor": [
                        'rgba(54, 162, 235, 0.1)'
                    ],
                    "borderColor": [
                        'rgba(54, 162, 235, 1)'
                    ]
                },
                {
                    "label" : "Error",
                    "data" : data[unite].error_count["/"],
                        "backgroundColor": [
                            'rgba(255, 99, 132, 0.1)'
                        ],
                        "borderColor": [
                            'rgba(255, 99, 132, 1)'
                        ]
                },
                {
                    "label" : "Scripted requests",
                    "data" : data[unite].dangerous_count["/"],
                        "backgroundColor": [
                            'rgba(255, 255, 0, 0.1)'
                        ],
                        "borderColor": [
                            'rgba(255, 255, 0, 1)'
                        ],
                },
                {
                    "label" : "Response time",
                    "data" : data[unite].res_time_moy["/"],
                    "backgroundColor": [
                        'rgba(0, 255, 0, 0.1)'
                    ],
                    "borderColor": [
                        'rgba(0, 255, 0, 1)'
                    ],
                }
                //,
                // datasets = [{
                //     "label" : "Stay length",
                //     "data" : data[unite].req_count,
                //     "backgroundColor": [
                //         'rgba(0, 255, 0, 0.1)'
                //     ],
                //     "borderColor": [
                //         'rgba(0, 255, 0, 1)'
                //     ],
                // },
                ]
                callback(datasets)
            })
        }
        test = () =>{
            alert(getParamValue("db"))
        }
        
        getGlobalDataFromTrackingApi = ( db => {
            return db
        })
        createGraphGeneral = async  () => {
            let datasets = []
            await getGraph( async result => {
                datasets = result
                // console.log(datasets)
            })
            console.log("testsetset2")
            let ctx = document.getElementById('graph-general').getContext('2d');
        
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    "labels": ["0","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49", "50", "51", "52", "53", "54", "55", "56", "57", "58", "59"],
                    "datasets": datasets,
                    options: {
                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                }
                            }]
                        },
                        responsive: true
                    }
                }
            })
            
        }
        updateGraphGeneral = async () => {
            await getGraph( async results => {
                let cpt = 0
                await results.forEach(result => {
                    // for(let i = 0; i < result.length; i++){
                        chart.data.datasets[cpt].data = result.data
                    // }
                    cpt++
                })
                console.log(chart.data.datasets[0])
                chart.update()  
            })
        }
        createGraphGeneral()  
    </script>
</head>
<body>
    LIVE<input id="boby" type="checkbox" value="CANVAS-LIVE" name="LIVE" id="LIVE" class="unite" checked>
    HOUR<input type="checkbox" value="CANVAS-HOUR" name="HOUR" id="HOUR" class="unite">
    DAY<input type="checkbox" value="CANVAS-DAY" name="DAY" id="DAY" class="unite">
    MONTH<input type="checkbox" value="CANVAS-MONTH" name="MONTH" id="MONTH" class="unite">
    YEAR<input type="checkbox" value="CANVAS-YEAR" name="YEAR" id="YEAR" class="unite">
    ALL<input type="checkbox" value="CANVAS-ALL" name="ALL" id="ALL" class="unite">
    <input type="button" value="showGraph" onclick="showGraph();" />
    <input type="button" value="test" onclick="createGraphGeneral()" />
    <div id="graph-info">
        <canvas id="graph-general"></canvas>
    </div>
    <div id="resume-info">
        <ul>
            <li class="characteristic"></li>
            <li class="characteristic"></li>
            <li class="characteristic"></li>
            <li class="characteristic"></li>
            <li class="characteristic"></li>
        </ul>
    </div>
    <div id="live">
        <canvas id="graph-live"></canvas>
        <canvas id="graph-live"></canvas>
        <canvas id="graph-live"></canvas>
        <canvas id="graph-live"></canvas>
        <canvas id="graph-live"></canvas>
        <canvas id="graph-live"></canvas>
        <canvas id="graph-live"></canvas>
    </div>
</body>


</html>